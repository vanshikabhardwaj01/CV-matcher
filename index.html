<script>
    let chart = null, storedData = null;

    async function analyze() {
        const file = document.getElementById('res').files[0];
        const jd = document.getElementById('jd').value;
        
        if (!file) return alert("Please upload a resume first!");

        document.getElementById('joblist').innerHTML = "<b>Finding real-time matches...</b>";

        // FormData banana zaroori hai file bhejne ke liye
        const formData = new FormData();
        formData.append('resume', file);
        formData.append('job_description', jd);

        try {
            // Yahan dhyan do: POST method aur body add kiya hai
            const res = await fetch('https://cv-matcher-kqdc-9yylkvzpb-vanshikabhardwajs-projects.vercel.app/match', {
                method: 'POST',
                body: formData
            });

            if (!res.ok) throw new Error("Server Error");

            const data = await res.json();
            storedData = data;

            // Fit Score Chart update
            if(chart) chart.destroy();
            chart = new ApexCharts(document.querySelector("#pie"), {
                series: [data.score, 100 - data.score],
                chart: { type: 'donut', height: 250 },
                colors: ['#fb7185', '#f1f5f9'],
                labels: ['Match', 'Gap'],
                plotOptions: { pie: { donut: { labels: { show: true, total: { show: true, label: 'Fit Score', formatter: () => data.score + '%' } } } } }
            });
            chart.render();

            // Skills Display
            document.getElementById('matched').innerHTML = data.matched_skills.map(s => `<span class="badge">${s}</span>`).join('') || "No skills found.";
            document.getElementById('missing').innerHTML = data.missing_skills.map(s => `<span class="badge-missing">${s}</span>`).join('') || "No gaps found!";
            
            // Learning Roadmap
            document.getElementById('roadmap').innerHTML = data.missing_skills.map(s => `
                <div class="roadmap-item">
                    <b style="color:var(--pink); font-size:14px;">Master ${s.toUpperCase()}</b><br>
                    <a href="https://www.youtube.com/results?search_query=learn+${s}+course" target="_blank" style="font-size:12px; color:var(--slate); text-decoration:none;">Watch Free Tutorial →</a>
                </div>
            `).join('') || "Your profile matches all required skills!";

            // Live Jobs
            document.getElementById('joblist').innerHTML = data.recommendations.map(j => `
                <div class="job-card">
                    <b style="color:var(--pink); font-size:14px;">${j.title}</b><br>
                    <small style="color:#94a3b8;">${j.company}</small><br>
                    <a href="${j.link}" target="_blank" style="font-size:11px; color:var(--slate); font-weight:800; text-decoration:none; display:inline-block; margin-top:8px;">Apply Now →</a>
                </div>
            `).join('') || "No matching jobs found.";

            document.getElementById('dl').style.display = 'block';

        } catch (error) {
            console.error(error);
            document.getElementById('joblist').innerHTML = "<b style='color:red;'>Error connecting to server!</b>";
        }
    }

    async function download() {
        if (!storedData) return;
        // Same backend link for report
        const res = await fetch('https://cv-matcher-kqdc-9yylkvzpb-vanshikabhardwajs-projects.vercel.app/download_report', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(storedData)
        });
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = "Insight_Report.pdf"; a.click();
    }
</script>
